<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PHIVOLCS Earthquake Tracker</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">

  <!-- Navbar -->
  <nav class="bg-white shadow-md py-4 px-6 flex justify-between items-center">
    <h1 class="text-xl font-bold text-red-600">PHIVOLCS Earthquake Tracker</h1>
    <div class="flex space-x-4">
      <a href="#" class="text-gray-700 hover:text-red-600">Home</a>
      <a href="#" class="text-gray-700 hover:text-red-600">About</a>
    </div>
  </nav>

  <!-- Main Content -->
  <main class="flex-grow container mx-auto px-4 py-6">
    <div class="bg-white rounded-lg shadow-md p-6">
      <h2 class="text-2xl font-semibold mb-4">Search Recent Earthquakes by City</h2>
      
      <div class="flex flex-col md:flex-row gap-4 mb-4">
        <input type="text" id="cityInput" placeholder="Enter Philippine city..." class="flex-1 border rounded px-4 py-2 focus:outline-none focus:ring-2 focus:ring-red-400">
        <button id="searchBtn" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">Search</button>
      </div>

      <div id="results" class="mt-6">
        <!-- Earthquake results will appear here -->
      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="bg-white shadow-inner py-4 mt-auto text-center">
    <p class="text-gray-500">&copy; 2025 PHIVOLCS Earthquake Tracker</p>
  </footer>

  <script>
    const searchBtn = document.getElementById('searchBtn');
    const resultsDiv = document.getElementById('results');
    const googleApiKey = 'AIzaSyBFSBBi31TWkJKbhwIQVnK4UdjUgksZ6nE';

    async function getCityCoordinates(city) {
      const response = await fetch(`https://maps.googleapis.com/maps/api/geocode/json?address=${city},PH&key=${googleApiKey}`);
      const data = await response.json();
      if(data.status === "OK") {
        return data.results[0].geometry.location;
      } else {
        alert("City not found!");
        return null;
      }
    }

    async function getEarthquakes() {
      // PHIVOLCS JSON endpoint (latest 50 earthquakes)
      const url = 'https://www.phivolcs.dost.gov.ph/index.php/earthquake/earthquake-list';
      const response = await fetch(url);
      const html = await response.text();

      // Parse the HTML to extract earthquake table data
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, 'text/html');
      const tableRows = doc.querySelectorAll('table tr');

      const earthquakes = [];
      tableRows.forEach((row, index) => {
        if(index === 0) return; // skip header
        const cells = row.querySelectorAll('td');
        if(cells.length >= 6) {
          earthquakes.push({
            date: cells[0].innerText.trim(),
            time: cells[1].innerText.trim(),
            latitude: parseFloat(cells[2].innerText.trim()),
            longitude: parseFloat(cells[3].innerText.trim()),
            depth: cells[4].innerText.trim(),
            magnitude: cells[5].innerText.trim(),
            location: cells[6] ? cells[6].innerText.trim() : ''
          });
        }
      });
      return earthquakes;
    }

    function filterByDistance(earthquakes, cityCoords, maxKm = 100) {
      function getDistance(lat1, lon1, lat2, lon2) {
        const R = 6371; // km
        const dLat = (lat2-lat1) * Math.PI / 180;
        const dLon = (lon2-lon1) * Math.PI / 180;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                  Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) *
                  Math.sin(dLon/2) * Math.sin(dLon/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
      }

      return earthquakes.filter(eq => getDistance(eq.latitude, eq.longitude, cityCoords.lat, cityCoords.lng) <= maxKm);
    }

    function displayEarthquakes(earthquakes) {
      if(earthquakes.length === 0){
        resultsDiv.innerHTML = `<p class="text-gray-700">No recent earthquakes found near this city.</p>`;
        return;
      }

      const list = earthquakes.map(eq => {
        return `
          <div class="border rounded p-4 mb-4 bg-gray-50 shadow-sm">
            <p><strong>Magnitude:</strong> ${eq.magnitude}</p>
            <p><strong>Location:</strong> ${eq.location}</p>
            <p><strong>Date & Time:</strong> ${eq.date} ${eq.time}</p>
            <p><strong>Depth:</strong> ${eq.depth}</p>
          </div>
        `;
      }).join('');

      resultsDiv.innerHTML = list;
    }

    searchBtn.addEventListener('click', async () => {
      const city = document.getElementById('cityInput').value.trim();
      if(!city) return alert("Please enter a city!");

      resultsDiv.innerHTML = `<p class="text-gray-500">Loading earthquakes...</p>`;
      const cityCoords = await getCityCoordinates(city);
      if(!cityCoords) return;

      const earthquakes = await getEarthquakes();
      const nearbyQuakes = filterByDistance(earthquakes, cityCoords, 100);
      displayEarthquakes(nearbyQuakes);
    });
  </script>
</body>
</html>
