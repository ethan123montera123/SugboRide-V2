<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SugboRide — Dashboard</title>

  <!-- PWA / Theme -->
  <meta name="theme-color" content="#2563EB" />
  <link rel="manifest" href="manifest.json">

  <!-- Icons -->
  <link rel="icon" type="image/png" href="assets/favicon.png">
  <link rel="apple-touch-icon" href="assets/logo-192.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Google Maps -->
  <script defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBFSBBi31TWkJKbhwIQVnK4UdjUgksZ6nE&libraries=places,visualization"></script>

  <!-- Firebase -->
  <script type="module" src="auth.js" defer></script>

  <style>
    .fade-in {
      animation: fadeIn 260ms ease;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(8px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .transit-scroll::-webkit-scrollbar {
      width: 8px;
    }

    .transit-scroll::-webkit-scrollbar-thumb {
      background-color: rgba(0, 0, 0, 0.12);
      border-radius: 8px;
    }
  </style>
</head>

<body class="bg-gray-50 min-h-screen font-sans flex flex-col">

  <!-- NAVBAR -->
  <nav class="w-full max-w-7xl mx-auto flex flex-col sm:flex-row items-center justify-between px-6 py-4 gap-3 sm:gap-0">
    <div class="flex items-center gap-3">
      <img src="assets/Logo.png" alt="SugboRide" class="w-10 h-10 rounded-md">
      <span class="text-2xl font-bold text-blue-600">SugboRide</span>
    </div>

    <div class="flex items-center gap-3 w-full sm:w-auto">
      <button id="historyBtn"
        class="bg-gray-100 px-4 py-2 rounded-full hover:bg-gray-200 transition shadow font-medium w-full sm:w-auto text-center">
        History
      </button>

      <button id="trafficToggle"
        class="bg-yellow-100 px-4 py-2 rounded-full hover:bg-yellow-200 transition shadow font-medium w-full sm:w-auto text-center">
        Traffic Off
      </button>

      <button id="logout-btn"
        class="bg-red-500 text-white px-5 py-2 rounded-full hover:bg-red-600 transition font-medium shadow w-full sm:w-auto">
        Logout
      </button>
    </div>
  </nav>

  <!-- TRIP PLANNER CARD -->
  <main class="w-full max-w-7xl mx-auto mt-6 px-4 lg:px-0 flex-1">
    <section class="bg-white rounded-3xl shadow-md p-6 transition-all duration-200">
      <div class="flex flex-col lg:flex-row gap-4">
        <div class="flex-1 flex flex-col gap-2">
          <label for="pointA" class="text-gray-700 font-medium">Starting Point</label>
          <input id="pointA" type="text" placeholder="Enter starting point"
            class="p-3 rounded-xl border border-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-400 w-full transition duration-200">
        </div>

        <div class="flex-1 flex flex-col gap-2">
          <label for="pointB" class="text-gray-700 font-medium">Destination</label>
          <input id="pointB" type="text" placeholder="Enter destination"
            class="p-3 rounded-xl border border-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-400 w-full transition duration-200">
        </div>

        <div class="flex items-end">
          <button id="planTrip"
            class="bg-blue-500 text-white px-6 py-3 rounded-2xl hover:bg-blue-600 shadow transition duration-200 font-medium">Plan
            Trip</button>
        </div>
      </div>
    </section>

    <!-- MAP + DETAILS -->
    <div class="flex flex-col lg:flex-row gap-6 mt-6">
      <div class="lg:w-2/3 w-full bg-white rounded-3xl shadow-md overflow-hidden">
        <div id="map" class="w-full h-96 lg:h-[560px]"></div>
      </div>

      <aside
        class="lg:w-1/3 w-full bg-white rounded-3xl shadow-md p-6 flex flex-col gap-3 max-h-[560px] overflow-y-auto transit-scroll">
        <h2 class="text-xl font-semibold text-gray-800 mb-2 border-b border-gray-200 pb-2">Trip Details</h2>
        <div id="transitInfo" class="text-gray-700 text-sm">
          <p class="text-gray-400">Suggested route steps will appear here after planning your trip.</p>
        </div>
      </aside>
    </div>
  </main>

  <!-- FOOTER -->
  <footer class="p-4 text-center text-gray-400 text-sm mt-6">
    &copy; 2025 SugboRide. All rights reserved.
  </footer>

  <!-- HISTORY MODAL -->
  <div id="historyModal"
    class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 transition duration-300">
    <div
      class="bg-white w-11/12 max-w-md rounded-2xl shadow-xl p-5 relative fade-in max-h-[80vh] overflow-y-auto transit-scroll">
      <h3 class="text-xl font-semibold text-gray-800 mb-4 text-center">Trip History</h3>
      <div id="historyList" class="space-y-2"></div>
      <button id="closeHistory"
        class="absolute top-3 right-3 text-gray-500 hover:text-gray-700 text-xl font-bold">&times;</button>
    </div>
  </div>

  <!-- SCRIPT -->
  <script type="module">
    import { auth } from './auth.js';
    import { signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js";

    const historyBtn = document.getElementById("historyBtn");
    const historyModal = document.getElementById("historyModal");
    const historyList = document.getElementById("historyList");
    const closeHistory = document.getElementById("closeHistory");
    const trafficBtn = document.getElementById("trafficToggle");
    const logoutBtn = document.getElementById("logout-btn");
    const planTripBtn = document.getElementById("planTrip");
    const transitInfo = document.getElementById("transitInfo");

    let map, directionsService, directionsRenderer, trafficLayer;
    let autocompleteA, autocompleteB;
    const geocoder = new google.maps.Geocoder();
    let trafficOn = false;
    let allRoutes = [];
    let selectedRouteIndex = null;
    let lastResult = null;

    window.addEventListener('DOMContentLoaded', () => {
      onAuthStateChanged(auth, (user) => {
        if (!user) window.location.href = "main.html";
      });

      logoutBtn.addEventListener('click', () => {
        signOut(auth).then(() => window.location.href = "main.html");
      });

      initMap();
      renderHistory();
    });

    // Initialize Map
    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 10.3157, lng: 123.8854 },
        zoom: 13,
      });
      directionsService = new google.maps.DirectionsService();
      directionsRenderer = new google.maps.DirectionsRenderer({ map: map });
      autocompleteA = new google.maps.places.Autocomplete(document.getElementById("pointA"));
      autocompleteB = new google.maps.places.Autocomplete(document.getElementById("pointB"));
      trafficLayer = new google.maps.TrafficLayer();
    }

    // Save History
    function saveHistory(origin, destination) {
      const history = JSON.parse(localStorage.getItem("tripHistory") || "[]");
      if (!history.find(h => h.origin === origin && h.destination === destination)) {
        history.unshift({ origin, destination, ts: Date.now() });
        if (history.length > 6) history.pop();
        localStorage.setItem("tripHistory", JSON.stringify(history));
        renderHistory();
      }
    }

    // Render History
    function renderHistory() {
      const history = JSON.parse(localStorage.getItem("tripHistory") || "[]");
      historyList.innerHTML = "";
      if (!history.length) {
        historyList.innerHTML = '<p class="text-gray-400 text-center py-3">No recent trips yet.</p>';
        return;
      }
      history.forEach((h) => {
        const btn = document.createElement("button");
        btn.className = "w-full text-left p-3 bg-gray-50 hover:bg-gray-100 rounded-xl transition text-gray-700";
        btn.innerText = `${h.origin} → ${h.destination}`;
        btn.addEventListener("click", () => {
          document.getElementById("pointA").value = h.origin;
          document.getElementById("pointB").value = h.destination;
          planTripBtn.click();
          closeModal();
        });
        historyList.appendChild(btn);
      });
    }

    // Modal Functions
    function openModal() {
      historyModal.classList.remove("hidden");
      historyModal.classList.add("flex");
    }

    function closeModal() {
      historyModal.classList.add("hidden");
      historyModal.classList.remove("flex");
    }

    historyBtn.addEventListener("click", openModal);
    closeHistory.addEventListener("click", closeModal);
    historyModal.addEventListener("click", (e) => {
      if (e.target === historyModal) closeModal();
    });

    // Traffic Toggle
    trafficBtn.addEventListener("click", () => {
      trafficOn = !trafficOn;
      trafficLayer.setMap(trafficOn ? map : null);
      trafficBtn.innerText = trafficOn ? "Traffic On" : "Traffic Off";
    });

    // Plan Trip
    planTripBtn.addEventListener("click", () => {
      const pointA = document.getElementById("pointA").value.trim();
      const pointB = document.getElementById("pointB").value.trim();
      if (!pointA || !pointB) return alert("Please enter both starting point and destination.");

      saveHistory(pointA, pointB);

      const request = {
        origin: pointA,
        destination: pointB,
        travelMode: google.maps.TravelMode.TRANSIT,
        provideRouteAlternatives: true
      };

      directionsService.route(request, (result, status) => {
        if (status === "OK") {
          lastResult = result;
          allRoutes = result.routes;

          if (!allRoutes.length) {
            transitInfo.innerHTML = "<p class='text-gray-400'>No routes found for that trip.</p>";
            return;
          }

          renderRouteList();
          directionsRenderer.setDirections(result);
          directionsRenderer.setRouteIndex(0);
        } else {
          alert("Could not calculate route. Please check your input.");
        }
      });
    });

    // Render Routes with Filter
    function renderRouteList(sortBy = null) {
      // clone to avoid permanently reordering the doctor's original order unless desired
      // but for simplicity we sort the in-memory array used for display
      if (sortBy === "distance") {
        allRoutes.sort((a, b) => a.legs[0].distance.value - b.legs[0].distance.value);
      } else if (sortBy === "duration") {
        allRoutes.sort((a, b) => a.legs[0].duration.value - b.legs[0].duration.value);
      }

      let listHtml = `
        <div class="flex justify-between items-center mb-3">
          <h3 class="text-lg font-semibold">Choose a Route</h3>
          <select id="routeFilter" class="border border-gray-300 text-sm rounded-lg p-2 focus:ring-blue-400 focus:border-blue-400">
            <option value="">Sort By</option>
            <option value="distance">Lowest Distance (KM)</option>
            <option value="duration">Shortest Arrival (Time)</option>
          </select>
        </div>
      `;

      allRoutes.forEach((route, idx) => {
        const leg = route.legs[0];
        listHtml += `
          <div class="border rounded-xl p-3 mb-3 hover:bg-blue-50 transition fade-in">
            <div class="flex justify-between items-start gap-2">
              <div>
                <div class="font-medium text-blue-700">Route ${idx + 1}</div>
                <div class="text-sm text-gray-600">Duration: ${leg.duration.text} • Distance: ${leg.distance.text}</div>
              </div>
              <div class="text-right">
                <button class="select-route inline-block bg-blue-500 text-white px-3 py-1 rounded-lg text-sm hover:bg-blue-600" data-index="${idx}">Select</button>
              </div>
            </div>
          </div>`;
      });
      transitInfo.innerHTML = listHtml;

      // Filter logic
      const filterEl = document.getElementById("routeFilter");
      filterEl.addEventListener("change", (e) => {
        renderRouteList(e.target.value);
      });

      // Route selection
      document.querySelectorAll('.select-route').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const idx = parseInt(e.currentTarget.getAttribute('data-index'), 10);
          selectRoute(idx);
        });
      });
    }

    // Select Route
    function selectRoute(index) {
      selectedRouteIndex = index;
      directionsRenderer.setDirections(lastResult);
      directionsRenderer.setRouteIndex(index);

      transitInfo.innerHTML = `
        <div class="text-center py-6 space-x-3">
          <p class="text-lg font-semibold mb-3 text-gray-700">You selected Route ${index + 1}</p>
          <div>
            <button id="backToRoutesBtn" class="bg-gray-300 text-gray-800 px-5 py-3 rounded-2xl hover:bg-gray-400 transition">Back</button>
            <button id="startTripBtn" class="bg-green-500 text-white px-6 py-3 rounded-2xl hover:bg-green-600 transition">Start Trip</button>
          </div>
        </div>`;

      document.getElementById("startTripBtn").addEventListener("click", showTripDetails);
      document.getElementById("backToRoutesBtn").addEventListener("click", () => renderRouteList());
    }

    // Trip Steps + Fare Calculation and Display
    async function showTripDetails() {
      if (selectedRouteIndex == null || !allRoutes[selectedRouteIndex]) return alert("No route selected.");

      const leg = allRoutes[selectedRouteIndex].legs[0];
      const steps = leg.steps;

      // Fare calculation logic:
      // - We'll compute a simple base fare from distance (meters -> km * perKmRate)
      // - perKmRate is a chosen constant; you can adjust it later or replace with exact fare data
      const distanceMeters = leg.distance.value || 0;
      const distanceKm = distanceMeters / 1000;
      // choose a minimum base fare and a per-km multiplier — tweak to your needs
      const perKmRate = 10; // PHP per km (example)
      const minFare = 10; // minimum fare floor
      let regularFare = Math.max(minFare, Math.round(distanceKm * perKmRate));

      // Round to 2 decimal places (though fares are usually whole pesos)
      regularFare = Number(regularFare.toFixed(2));

      // Discounts: 20% off for Student, PWD, Senior (common practice)
      const discountRate = 0.20;
      const studentFare = Number((regularFare * (1 - discountRate)).toFixed(2));
      const pwdFare = Number((regularFare * (1 - discountRate)).toFixed(2));
      const seniorFare = Number((regularFare * (1 - discountRate)).toFixed(2));

      // Build Trip Steps HTML including fare section
      let html = `<h3 class="text-lg font-semibold mb-3">Trip Steps</h3>`;

      // Basic route summary
      html += `
        <div class="mb-3 p-3 border rounded-xl bg-gray-50">
          <div class="text-sm text-gray-600 mb-1"><strong>From:</strong> ${leg.start_address || ''}</div>
          <div class="text-sm text-gray-600 mb-1"><strong>To:</strong> ${leg.end_address || ''}</div>
          <div class="text-sm text-gray-600"><strong>Distance:</strong> ${leg.distance?.text || ''} • <strong>Duration:</strong> ${leg.duration?.text || ''}</div>
        </div>
      `;

      // Fare Info Card
      html += `
        <div class="mt-2 bg-white p-3 rounded-lg border border-gray-200 mb-4">
          <h4 class="font-medium text-gray-800 mb-2">Fare Details</h4>
          <div class="grid grid-cols-2 gap-2 text-sm">
            <div class="flex justify-between">
              <span>Regular Fare:</span>
              <span class="font-semibold text-gray-800">₱${regularFare}</span>
            </div>
            <div class="flex justify-between">
              <span>Student Fare (20% off):</span>
              <span class="font-semibold text-gray-800">₱${studentFare}</span>
            </div>
            <div class="flex justify-between">
              <span>PWD Fare (20% off):</span>
              <span class="font-semibold text-gray-800">₱${pwdFare}</span>
            </div>
            <div class="flex justify-between">
              <span>Senior Fare (20% off):</span>
              <span class="font-semibold text-gray-800">₱${seniorFare}</span>
            </div>
          </div>
          <p class="text-xs text-gray-500 mt-2">Fare estimated from distance. Adjust per-route fare rules as needed.</p>
        </div>
      `;

      // Steps list
      for (let step of steps) {
        // sanitize instructions: Google returns HTML in instructions; keep it safe for innerHTML here since this is the original usage
        html += `
          <div class="rounded-xl p-3 mb-3 border">
            <div class="font-medium">${step.instructions}</div>
            <div class="text-sm text-gray-600">${step.distance?.text || ''} • ${step.duration?.text || ''}</div>
          </div>`;
      }

      // Add back button and optionally start/finish controls
      html += `
        <div class="flex justify-between mt-3">
          <button id="backToRoutes" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-2xl hover:bg-gray-300">Back</button>
          <button id="endTripBtn" class="bg-red-500 text-white px-4 py-2 rounded-2xl hover:bg-red-600">End Trip</button>
        </div>
      `;

      transitInfo.innerHTML = html;

      // Hook up the buttons
      document.getElementById("backToRoutes").addEventListener("click", () => renderRouteList());
      document.getElementById("endTripBtn").addEventListener("click", () => {
        alert("Trip ended.");
        // optional: clear selected route and map overlay
        selectedRouteIndex = null;
        // reset directions rendering (keeps map view)
        directionsRenderer.setDirections({ routes: [] });
        transitInfo.innerHTML = "<p class='text-gray-400'>Suggested route steps will appear here after planning your trip.</p>";
      });
    }

    // Register SW
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js');
      });
    }
  </script>
</body>

</html>