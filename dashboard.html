<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Sugbo Ride Dashboard</title>
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<!-- Google Maps API -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBFSBBi31TWkJKbhwIQVnK4UdjUgksZ6nE&libraries=places"></script>
</head>
<body class="flex min-h-screen bg-gray-100">

<!-- Sidebar -->
<aside class="bg-blue-600 text-white w-64 p-6 flex-shrink-0">
  <h1 class="text-2xl font-bold mb-6">Sugbo Ride</h1>
  <nav class="space-y-4">
    <a href="#" class="block py-2 px-3 rounded hover:bg-blue-500 transition">Dashboard</a>
    <a href="#" class="block py-2 px-3 rounded hover:bg-blue-500 transition">Account</a>
    <a href="#" id="logoutBtn" class="block py-2 px-3 rounded hover:bg-blue-500 transition">Logout</a>
  </nav>
</aside>

<!-- Main Content -->
<div class="flex-1 p-6">
  <header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-2">
    <h2 class="text-3xl font-bold text-gray-800" id="welcomeMessage">Dashboard</h2>
    <span id="userEmail" class="text-gray-600"></span>
  </header>

  <main class="space-y-6">
    <!-- City Selector -->
    <div class="bg-white p-6 rounded-xl shadow-lg">
      <h3 class="text-xl font-semibold mb-4">Select City</h3>
      <select id="citySelect" class="p-3 border rounded-xl w-full focus:ring-2 focus:ring-blue-500">
        <option value="Cebu City" selected>Cebu City</option>
      </select>
    </div>

    <!-- Directions Input -->
    <div class="bg-white p-6 rounded-xl shadow-lg">
      <h3 class="text-xl font-semibold mb-4">Get Directions</h3>
      <form id="routeForm" class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <input type="text" id="pointA" placeholder="Point A" class="p-3 border rounded-xl w-full focus:ring-2 focus:ring-blue-500" required />
        <input type="text" id="pointB" placeholder="Point B" class="p-3 border rounded-xl w-full focus:ring-2 focus:ring-blue-500" required />
        <button type="submit" class="bg-blue-600 text-white rounded-xl p-3 hover:bg-blue-700 transition font-semibold">Show Route</button>
      </form>
    </div>

    <!-- Two Columns: Map + Transit Instructions -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <!-- Left Column: Map -->
      <div id="map" class="w-full h-[500px] rounded-xl shadow-lg"></div>

      <!-- Right Column: Transit Instructions -->
      <div id="transitInfo" class="bg-white p-6 rounded-xl shadow-lg overflow-y-auto max-h-[500px]">
        <h3 class="text-xl font-semibold mb-4">What to Ride</h3>
        <ul id="transitSteps" class="space-y-4 text-gray-700"></ul>
      </div>
    </div>
  </main>
</div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyC6i6Dteqfk45ghsdzzBsLBMhnBtbtY8EA",
    authDomain: "sugboride.firebaseapp.com",
    databaseURL: "https://sugboride-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "sugboride",
    storageBucket: "sugboride.firebasestorage.app",
    messagingSenderId: "104362918043",
    appId: "1:104362918043:web:19a07d398689f6aa61c63e",
    measurementId: "G-SW0TN1HJG1"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const database = firebase.database();

  auth.onAuthStateChanged(user => {
    if (user) {
      document.getElementById('userEmail').textContent = user.email;
      database.ref('users/' + user.uid).once('value').then(snapshot => {
        const firstName = snapshot.val()?.firstName || user.email;
        document.getElementById('welcomeMessage').textContent = `Welcome, ${firstName}!`;
      });
    } else {
      window.location.href = "login.html";
    }
  });

  document.getElementById('logoutBtn').addEventListener('click', () => {
    auth.signOut().then(() => window.location.href = "login.html");
  });

  // Google Maps
  let map, directionsService, directionsRenderer;
  let markerA = null, markerB = null;
  let autocompleteA, autocompleteB;

  function initMap() {
    map = new google.maps.Map(document.getElementById("map"), { center: { lat: 10.3157, lng: 123.8854 }, zoom: 12 });
    directionsService = new google.maps.DirectionsService();
    directionsRenderer = new google.maps.DirectionsRenderer({ map: map });
    initAutocomplete();
  }

  function initAutocomplete() {
    const bounds = new google.maps.LatLngBounds({ lat: 10.232, lng: 123.750 }, { lat: 10.500, lng: 124.000 });
    if (markerA) markerA.setMap(null);
    if (markerB) markerB.setMap(null);

    autocompleteA = new google.maps.places.Autocomplete(document.getElementById("pointA"), { bounds, strictBounds: true, componentRestrictions: { country: "PH" }, fields: ["geometry", "name"] });
    autocompleteB = new google.maps.places.Autocomplete(document.getElementById("pointB"), { bounds, strictBounds: true, componentRestrictions: { country: "PH" }, fields: ["geometry", "name"] });

    autocompleteA.addListener("place_changed", () => {
      const place = autocompleteA.getPlace(); if (!place.geometry) return;
      if (markerA) markerA.setMap(null);
      markerA = new google.maps.Marker({ map, position: place.geometry.location, label: "A" });
      map.panTo(place.geometry.location);
    });

    autocompleteB.addListener("place_changed", () => {
      const place = autocompleteB.getPlace(); if (!place.geometry) return;
      if (markerB) markerB.setMap(null);
      markerB = new google.maps.Marker({ map, position: place.geometry.location, label: "B" });
      map.panTo(place.geometry.location);
    });
  }

  document.getElementById("citySelect").addEventListener("change", initAutocomplete);
  window.onload = initMap;

  const routeForm = document.getElementById("routeForm");
  routeForm.addEventListener("submit", (e) => {
    e.preventDefault();
    const pointA = document.getElementById("pointA").value;
    const pointB = document.getElementById("pointB").value;
    if (!pointA || !pointB) return;

    const transitStepsList = document.getElementById("transitSteps");
    transitStepsList.innerHTML = "";

    directionsService.route({
      origin: pointA,
      destination: pointB,
      travelMode: 'TRANSIT'
    }, (result, status) => {
      if (status === 'OK') {
        directionsRenderer.setDirections(result);

        const steps = result.routes[0].legs[0].steps;
        steps.forEach((step, index) => {
          const li = document.createElement("li");
          if (step.travel_mode === "WALKING") {
            li.innerHTML = `ðŸš¶ Walk for ${step.distance.text} from ${step.start_location.lat().toFixed(5)},${step.start_location.lng().toFixed(5)}`;
          } else if (step.travel_mode === "TRANSIT") {
            const transit = step.transit;
            li.innerHTML = `<strong>${transit.line.vehicle.name}</strong> ${transit.line.short_name ? "(" + transit.line.short_name + ")" : ""} <br>
              Board at: ${transit.departure_stop.name} <br>
              Alight at: ${transit.arrival_stop.name} <br>
              Duration: ${step.duration.text}`;
          }
          transitStepsList.appendChild(li);
        });
      } else {
        alert("Transit directions request failed: " + status);
      }
    });
  });
</script>
</body>
</html>
